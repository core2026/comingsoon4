<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acekallas | Personal Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b1120; --text: #f8fafc; --card: rgba(30, 41, 59, 0.5); --label: #94a3b8; --gold: #fbbf24; }
        body.light-mode { --bg: #f1f5f9; --text: #1e293b; --card: rgba(255, 255, 255, 0.8); --label: #64748b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; transition: background 0.3s ease; }
        .container { width: 95%; max-width: 500px; text-align: center; position: relative; }
        .theme-toggle { position: absolute; top: -50px; right: 0; background: var(--card); border: 1px solid rgba(128,128,128,0.2); padding: 8px 12px; border-radius: 12px; cursor: pointer; color: var(--text); font-size: 0.8rem; }
        h1 { font-size: 2.2rem; margin-bottom: 25px; letter-spacing: -1px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; text-align: left; }
        .card { background: var(--card); padding: 18px; border-radius: 20px; border: 1px solid rgba(128,128,128,0.1); backdrop-filter: blur(12px); }
        .full { grid-column: span 2; }
        .label { font-size: 0.6rem; text-transform: uppercase; color: var(--label); letter-spacing: 1px; font-weight: 700; }
        .val { font-size: 1.5rem; font-weight: 800; display: block; margin-top: 4px; }
        .status { color: var(--gold); font-size: 1rem; font-weight: 600; margin-top: 4px; display: block; }
        .footer { text-align: center; margin-top: 25px; font-size: 0.7rem; color: var(--label); line-height: 1.6; }
        #countdown { font-weight: bold; color: var(--gold); }
    </style>
</head>
<body>

<div class="container">
    <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">ðŸŒ™ Dark</button>
    <h1 id="city-title">Fair Oaks Ranch</h1>
    
    <div class="grid">
        <div class="card">
            <span class="label">Actual Temp</span>
            <span class="val" id="actual">--Â°</span>
        </div>
        <div class="card">
            <span class="label">Feels Like</span>
            <span class="val" id="feels">--Â°</span>
        </div>
        <div class="card">
            <span class="label">Cedar Risk</span>
            <span class="val" id="cedar">--</span>
        </div>
        <div class="card" id="uv-card">
            <span class="label">UV Index</span>
            <span class="val" id="uv">--</span>
        </div>
        <div class="card full">
            <span class="label">Car Wash</span>
            <span class="status" id="wash">---</span>
        </div>
        <div class="card full">
            <span class="label">Outlook</span>
            <div id="clears" style="font-size: 0.85rem; margin-top: 4px;">---</div>
        </div>
    </div>
    
    <div class="footer">
        <div>Next API sync in: <span id="countdown">--:--</span></div>
        <div id="time" style="opacity: 0.6;">Syncing...</div>
    </div>
</div>

<script>
    function toggleTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        document.getElementById('theme-btn').innerText = isLight ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    }

    if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-mode');
        document.getElementById('theme-btn').innerText = 'â˜€ï¸ Light';
    }

    function startTimer(timestamp) {
        if (!timestamp) return;
        const cacheExpiry = timestamp + (15 * 60 * 1000); 
        
        const timerInt = setInterval(() => {
            const now = Date.now();
            const diff = cacheExpiry - now;
            
            if (diff > 0) {
                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                document.getElementById('countdown').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            } else {
                document.getElementById('countdown').innerText = "Update Ready";
                // I removed the auto-refresh to stop the loop. 
                // It will refresh on the next manual page load.
                clearInterval(timerInt);
            }
        }, 1000);
    }

    async function update() {
        try {
            const res = await fetch("https://pollen-data.acekallas.com");
            const d = await res.json();
            
            // Fixed IDs to match Worker output
            document.getElementById('actual').innerText = (d.actualTemp || d.temp || "--") + "Â°";
            document.getElementById('feels').innerText = (d.feelsLike || "--") + "Â°";
            document.getElementById('cedar').innerText = d.cedar;
            document.getElementById('uv').innerText = d.uvIndex;
            document.getElementById('wash').innerText = d.carWash;
            document.getElementById('clears').innerText = d.clearsUp;
            
            if (d.timestamp) {
                document.getElementById('time').innerText = "Last API Call: " + new Date(d.timestamp).toLocaleTimeString();
                startTimer(d.timestamp);
            }

            const uvCard = document.getElementById('uv-card');
            if (d.uvIndex <= 2) uvCard.style.backgroundColor = "rgba(74, 222, 128, 0.15)"; 
            else if (d.uvIndex <= 5) uvCard.style.backgroundColor = "rgba(250, 204, 21, 0.15)"; 
            else uvCard.style.backgroundColor = "rgba(248, 113, 113, 0.2)";

        } catch(e) { 
            document.getElementById('time').innerText = "API Rate Limited - Cooling Down"; 
        }
    }
    update();
</script>
</body>
</html>
