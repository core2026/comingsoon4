<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollen Radar | Dual-Engine Analytics</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root { --accent: #10b981; --bg: #020617; --glass: rgba(255, 255, 255, 0.04); }
        body { background: var(--bg); color: white; margin: 0; padding: 15px; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; }
        
        .dashboard { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 12px; }
        .tile { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px; backdrop-filter: blur(12px); }
        
        /* DATA COMPARISON ROWS */
        .comp-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .source-box { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .source-label { font-size: 0.55rem; text-transform: uppercase; color: #64748b; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 4px; }
        .source-val { font-size: 1.4rem; font-weight: 800; color: #f8fafc; }
        
        h2 { font-size: 0.65rem; text-transform: uppercase; color: #94a3b8; margin: 0 0 5px 0; letter-spacing: 1px; }
        .big-title { font-size: 1.1rem; font-weight: 700; }
        
        #map { height: 200px; border-radius: 18px; z-index: 1; background: #000; border: 1px solid rgba(255,255,255,0.1); }
        
        .btn-main { background: var(--accent); width: 100%; margin-top: 10px; padding: 14px; font-size: 0.85rem; border: none; border-radius: 16px; color: white; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { opacity: 0.9; }

        .tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: rgba(16, 185, 129, 0.2); color: #10b981; font-weight: 700; }
    </style>
</head>
<body>

<div id="capture-area" class="dashboard">
    <div class="tile" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2>‚óè Dual-Engine Local Radar</h2>
            <div id="city-name" class="big-title">Detecting Location...</div>
        </div>
        <span class="tag">LIVE SYNC</span>
    </div>

    <div class="tile">
        <h2>Mountain Cedar <span style="color:var(--accent)">(Primary Allergen)</span></h2>
        <div class="comp-row">
            <div class="source-box">
                <div class="source-label">Ambee (Grains)</div>
                <div id="ambee-cedar" class="source-val">--</div>
            </div>
            <div class="source-box">
                <div class="source-label">Tomorrow.io</div>
                <div id="tomorrow-cedar" class="source-val">--</div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="tile" style="padding: 15px;">
            <h2>Grass Pollen</h2>
            <div class="source-label" style="margin-top:8px;">Ambee / Tomorrow</div>
            <div style="font-size: 1.1rem; font-weight: 800;">
                <span id="ambee-grass">--</span> <span style="color:#475569; font-weight:400;">/</span> <span id="tomorrow-grass">--</span>
            </div>
        </div>
        <div class="tile" style="padding: 15px;">
            <h2>Weed Pollen</h2>
            <div class="source-label" style="margin-top:8px;">Ambee / Tomorrow</div>
            <div style="font-size: 1.1rem; font-weight: 800;">
                <span id="ambee-weed">--</span> <span style="color:#475569; font-weight:400;">/</span> <span id="tomorrow-weed">--</span>
            </div>
        </div>
    </div>

    <div class="tile" style="padding: 5px;">
        <div id="map"></div>
    </div>

    <div class="tile">
        <h2>Health Recommendation</h2>
        <div id="health-advice" style="font-size: 0.8rem; line-height:1.5; color: #cbd5e1; margin-top:5px;">
            Comparing live data streams...
        </div>
    </div>
</div>

<div style="width: 100%; max-width: 480px; padding: 10px;">
    <button class="btn-main" onclick="takeSnapshot()">üì∏ Save Dual-Data Report</button>
    <button class="btn-main" style="background:rgba(255,255,255,0.05); color:#94a3b8;" onclick="handleShare()">üîó Copy Share Link</button>
</div>

<script>
    const WORKER_URL = 'https://pollen-proxy.acekallas.workers.dev';
    let map, marker, currentLat, currentLon;

    window.onload = () => {
        navigator.geolocation.getCurrentPosition(
            (p) => updateUI(p.coords.latitude, p.coords.longitude),
            () => updateUI(29.704, -98.636) // Default Texas
        );
    };

    async function updateUI(lat, lon) {
        currentLat = lat; currentLon = lon;
        try {
            // Get City Name
            const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const g = await geo.json();
            document.getElementById('city-name').innerText = g.address.city || g.address.town || "Fair Oaks Ranch";

            // Fetch Dual Data from your Worker
            const res = await fetch(`${WORKER_URL}?lat=${lat}&lon=${lon}`);
            const result = await res.json();
            
            // Note: I'm assuming your updated Worker returns BOTH now. 
            // If it only returns one, we can adjust the Worker to fetch both in parallel.
            renderDashboard(result);
        } catch (e) { console.error(e); }
    }

    function renderDashboard(result) {
        // AMBEE DATA
        const a = result.ambee || {};
        const aCedar = a.Species?.Tree["Cypress / Juniper / Cedar"] || 0;
        document.getElementById('ambee-cedar').innerText = aCedar;
        document.getElementById('ambee-grass').innerText = a.Count?.grass_pollen || 0;
        document.getElementById('ambee-weed').innerText = a.Count?.weed_pollen || 0;

        // TOMORROW.IO DATA (Normalized to count scale)
        const t = result.tomorrow || {};
        const tCedar = (t.treeIndex || 0) * 400; 
        document.getElementById('tomorrow-cedar').innerText = tCedar;
        document.getElementById('tomorrow-grass').innerText = (t.grassIndex || 0) * 20;
        document.getElementById('tomorrow-weed').innerText = (t.weedIndex || 0) * 20;

        // ACCENT COLOR (Based on the higher of the two)
        const maxCedar = Math.max(aCedar, tCedar);
        let color = '#10b981';
        let advice = "üü¢ <b>Engines Agree:</b> Pollen levels are low. Clean air detected.";
        
        if (maxCedar > 500) {
            color = '#ef4444';
            advice = "üî¥ <b>High Alert:</b> Both sensors detect significant Cedar. Heavy symptoms likely.";
        } else if (maxCedar > 100) {
            color = '#f59e0b';
            advice = "üü° <b>Moderate:</b> Allergy triggers present. Consider pre-treatment.";
        }

        document.documentElement.style.setProperty('--accent', color);
        document.getElementById('health-advice').innerHTML = advice;

        if (!map) {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([lat, lon], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }
    }

    function takeSnapshot() {
        html2canvas(document.querySelector("#capture-area"), { backgroundColor: "#020617", useCORS: true }).then(c => {
            const l = document.createElement('a'); l.download = `Pollen-DualRadar.png`; l.href = c.toDataURL(); l.click();
        });
    }

    function handleShare() {
        navigator.clipboard.writeText(window.location.href);
        alert("Link copied!");
    }
</script>
</body>
</html>
