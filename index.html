<!-- Acekallas Weather & Allergy â€” v1.9 -->
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" id="theme-meta" content="#0b1120">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Weather">
    <link rel="manifest" href="/manifest.json">
    <title>Acekallas Weather & Allergy</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="//www.pollenapps.com/df/tools/aa/css/load.css">
    <style>
        /* â”€â”€ Theme variables â”€â”€ */
        :root {
            --bg: #0b1120; --text: #f8fafc; --card: rgba(30,41,59,0.4);
            --label: #94a3b8; --accent: #38bdf8; --border: rgba(255,255,255,0.05);
            --card-solid: #1e293b; --shimmer-from: rgba(255,255,255,0.04); --shimmer-to: rgba(255,255,255,0.10);
            --input-bg: rgba(30,41,59,0.4); --search-input-color: #fff;
        }
        [data-theme="light"] {
            --bg: #f0f4f8; --text: #0f172a; --card: rgba(255,255,255,0.85);
            --label: #64748b; --accent: #0284c7; --border: rgba(0,0,0,0.07);
            --card-solid: #ffffff; --shimmer-from: rgba(0,0,0,0.04); --shimmer-to: rgba(0,0,0,0.08);
            --input-bg: rgba(255,255,255,0.85); --search-input-color: #0f172a;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text);
               padding: 20px; padding-top: max(20px, env(safe-area-inset-top));
               padding-bottom: max(20px, env(safe-area-inset-bottom));
               margin: 0; display: flex; justify-content: center; transition: background 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 500px; }

        /* â”€â”€ Header row â”€â”€ */
        .header-row { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 4px; }
        .header-left { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; }
        .weather-icon { font-size: 2rem; line-height: 1; margin-right: 6px; }
        h1 { font-size: 2rem; font-weight: 800; margin: 0; display: inline; }
        .header-actions { display: flex; gap: 8px; flex-shrink: 0; padding-top: 4px; }
        .icon-btn { background: var(--card); border: 1px solid var(--border); border-radius: 12px;
                    color: var(--label); cursor: pointer; width: 36px; height: 36px;
                    display: flex; align-items: center; justify-content: center; transition: all 0.2s; padding: 0; }
        .icon-btn:hover { background: var(--card-solid); color: var(--text); }

        /* â”€â”€ Relay/VPN banner â”€â”€ */
        #relay-banner { display: none; align-items: center; gap: 10px;
                        background: rgba(251,146,60,0.12); border: 1px solid rgba(251,146,60,0.35);
                        border-radius: 16px; padding: 12px 16px; margin-bottom: 14px;
                        animation: fadeIn 0.4s ease; }
        #relay-banner.visible { display: flex; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:none; } }
        #relay-banner .relay-icon { font-size: 1.3rem; flex-shrink: 0; }
        #relay-banner .relay-text { flex: 1; }
        #relay-banner .relay-title { font-size: 0.82rem; font-weight: 800; color: #fb923c; display: block; }
        #relay-banner .relay-sub { font-size: 0.72rem; color: var(--label); display: block; margin-top: 2px; line-height: 1.4; }
        /* keep tiny badge in header too for reference but hide it â€” banner is primary */
        #vpn-badge { display: none; }

        /* â”€â”€ Pull to refresh â”€â”€ */
        #ptr-indicator { position: fixed; top: 0; left: 50%; transform: translateX(-50%) translateY(-60px);
                         background: var(--accent); color: #0b1120; border-radius: 0 0 20px 20px;
                         padding: 8px 20px; font-size: 0.8rem; font-weight: 800;
                         transition: transform 0.3s; z-index: 100; display: flex; align-items: center; gap: 6px; }
        #ptr-indicator.visible { transform: translateX(-50%) translateY(0); }
        @keyframes ptr-spin { to { transform: rotate(360deg); } }
        #ptr-spinner { display: none; width: 14px; height: 14px; border: 2px solid #0b112040;
                       border-top-color: #0b1120; border-radius: 50%; animation: ptr-spin 0.7s linear infinite; }
        #ptr-spinner.spin { display: block; }

        /* â”€â”€ Toast notification â”€â”€ */
        #toast { position: fixed; bottom: max(24px, env(safe-area-inset-bottom)); left: 50%;
                 transform: translateX(-50%) translateY(80px); background: var(--card-solid);
                 color: var(--text); border-radius: 14px; padding: 12px 20px; font-size: 0.85rem;
                 font-weight: 700; box-shadow: 0 8px 30px rgba(0,0,0,0.3); transition: transform 0.35s;
                 z-index: 200; white-space: nowrap; }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* â”€â”€ GPS button â”€â”€ */
        #gps-btn { background: var(--card); color: var(--text); border: 1px solid var(--border);
                   padding: 16px; border-radius: 16px; width: 100%; cursor: pointer; font-weight: 800;
                   display: flex; align-items: center; justify-content: center; gap: 10px;
                   margin-bottom: 15px; transition: border-color 0.3s; }
        #gps-btn.pulse { border-color: #fb923c; animation: gps-pulse 1.8s ease-in-out infinite; }
        @keyframes gps-pulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(251,146,60,0.4); }
            50%      { box-shadow: 0 0 0 8px rgba(251,146,60,0); }
        }

        /* â”€â”€ Search â”€â”€ */
        .search-container { display: flex; gap: 0; background: var(--input-bg); padding: 4px;
                            border-radius: 14px; border: 1px solid var(--border); margin-bottom: 20px; align-items: center; }
        .search-container input { background: transparent; border: none; color: var(--search-input-color);
                                  padding: 10px 10px; width: 100%; outline: none; font-family: inherit; font-weight: 600; font-size: 0.95rem; min-width: 0; }
        .search-container input::placeholder { color: var(--label); }
        .search-container button { background: var(--accent); color: #0b1120; border: none; border-radius: 10px;
                                   padding: 10px 14px; cursor: pointer; font-weight: 800; white-space: nowrap;
                                   font-size: 0.88rem; flex-shrink: 0; letter-spacing: 0.02em; }

        /* â”€â”€ Outdoor score card â”€â”€ */
        .outdoor-card { grid-column: span 2; background: var(--card); border-radius: 24px; border: 1px solid var(--border);
                        backdrop-filter: blur(10px); padding: 20px; position: relative; overflow: hidden; }
        .outdoor-score-row { display: flex; align-items: center; gap: 16px; }
        .outdoor-score-circle { width: 72px; height: 72px; border-radius: 50%; display: flex; flex-direction: column;
                                align-items: center; justify-content: center; flex-shrink: 0; border: 3px solid; }
        .outdoor-score-num { font-size: 1.6rem; font-weight: 800; line-height: 1; }
        .outdoor-score-label { font-size: 0.55rem; text-transform: uppercase; font-weight: 800; letter-spacing: 0.05em; }
        .outdoor-score-detail { flex: 1; }
        .outdoor-score-title { font-size: 1rem; font-weight: 800; display: block; }
        .outdoor-score-desc { font-size: 0.72rem; color: var(--label); display: block; margin-top: 3px; line-height: 1.4; }
        .outdoor-score-factors { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .score-factor { font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 8px;
                        background: rgba(255,255,255,0.06); color: var(--label); }
        /* â”€â”€ Weather condition subtitle â”€â”€ */
        #condition-line { font-size: 0.78rem; color: var(--label); margin: 2px 0 0 0; font-weight: 600; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid var(--border);
                backdrop-filter: blur(10px); position: relative; overflow: hidden; transition: background 0.3s; }

        /* â”€â”€ Skeleton shimmer â”€â”€ */
        .skeleton { position: relative; overflow: hidden; }
        .skeleton::after { content: ''; position: absolute; inset: 0;
                           background: linear-gradient(90deg, transparent 0%, var(--shimmer-to) 50%, transparent 100%);
                           background-size: 200% 100%; animation: shimmer 1.4s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .skeleton .val, .skeleton .label { color: transparent; background: var(--shimmer-from); border-radius: 6px; }

        /* â”€â”€ Card expand â”€â”€ */
        .card-toggle { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.07);
                       border: none; border-radius: 8px; color: var(--label); cursor: pointer;
                       width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; padding: 0; }
        .card-toggle svg { transition: transform 0.25s; }
        .card-toggle.open svg { transform: rotate(90deg); }
        .card-info { max-height: 0; overflow: hidden; transition: max-height 0.35s ease, opacity 0.3s ease; opacity: 0; }
        .card-info.open { max-height: 200px; opacity: 1; }
        .card-info-inner { border-top: 1px solid var(--border); margin-top: 12px; padding-top: 10px;
                           font-size: 0.78rem; line-height: 1.5; color: var(--label); }
        .info-badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; margin-bottom: 5px; }

        /* â”€â”€ Pollen wrapper â”€â”€ */
        .pollen-wrapper { grid-column: span 2; background: var(--card); border-radius: 24px; border: 1px solid var(--border); }

        /* â”€â”€ Pollen loading notice (banner above widget) â”€â”€ */
        .pollen-notice-wrap { position: relative; }
        #pollen-iframe { width: 100%; height: 270px; border: none; display: block; }
        #pollen-notice {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 18px; background: rgba(56,189,248,0.08);
            border-bottom: 1px solid rgba(56,189,248,0.15);
            transition: max-height 0.5s ease, opacity 0.5s ease, padding 0.5s ease;
            max-height: 100px; overflow: hidden;
        }
        #pollen-notice.hidden { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; }
        .pn-icon { font-size: 1.4rem; flex-shrink: 0; animation: pn-bounce 2s ease-in-out infinite; }
        @keyframes pn-bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }
        .pn-text { flex: 1; }
        .pn-title { font-size: 0.8rem; font-weight: 800; color: #38bdf8; display: block; }
        .pn-sub { font-size: 0.68rem; color: var(--label); display: block; margin-top: 2px; line-height: 1.5; }
        .pn-bar { width: 60px; height: 3px; background: rgba(56,189,248,0.2); border-radius: 2px; overflow: hidden; flex-shrink: 0; }
        .pn-bar-fill { height: 100%; width: 35%; background: #38bdf8; border-radius: 2px; animation: pn-slide 1.4s ease-in-out infinite; }
        @keyframes pn-slide { 0%{transform:translateX(-200%)} 100%{transform:translateX(450%)} }
        .pollen-level-row { padding: 12px 16px 4px; display: flex; flex-direction: column; gap: 8px; border-top: 1px solid var(--border); }
        .pollen-level-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 800; color: var(--label); }
        .pollen-level-btns { display: flex; gap: 6px; }
        .plvl-btn { flex: 1; padding: 6px 4px; border-radius: 10px; border: 1px solid var(--border);
                    background: rgba(255,255,255,0.05); color: var(--label); font-size: 0.7rem; font-weight: 800;
                    cursor: pointer; font-family: inherit; transition: all 0.2s; white-space: nowrap; }
        .plvl-btn.active-0 { background: rgba(74,222,128,0.2);  border-color: #4ade80; color: #4ade80; }
        .plvl-btn.active-1 { background: rgba(163,230,53,0.2);  border-color: #a3e635; color: #a3e635; }
        .plvl-btn.active-2 { background: rgba(251,191,36,0.2);  border-color: #fbbf24; color: #fbbf24; }
        .plvl-btn.active-3 { background: rgba(249,115,22,0.2);  border-color: #f97316; color: #f97316; }
        .plvl-btn.active-4 { background: rgba(248,113,113,0.2); border-color: #f87171; color: #f87171; }
        .pollen-chips { padding: 14px 16px; display: flex; flex-wrap: wrap; gap: 8px; border-top: 1px solid var(--border); }
        .chip { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.06);
                border: 1px solid var(--border); border-radius: 20px; padding: 6px 12px; font-size: 0.75rem; font-weight: 700; color: var(--text); }

        /* â”€â”€ Triggers card â”€â”€ */
        .triggers-card { grid-column: span 2; background: var(--card); border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(10px); padding: 20px; }
        .triggers-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 12px; }
        .trigger-item { display: flex; flex-direction: column; align-items: center; gap: 6px; text-align: center; }
        .trigger-icon { font-size: 1.4rem; }
        .trigger-label { font-size: 0.6rem; text-transform: uppercase; color: var(--label); font-weight: 800; }
        .trigger-level { font-size: 0.75rem; font-weight: 800; padding: 3px 8px; border-radius: 8px; }
        .trigger-note { font-size: 0.6rem; color: var(--label); }
        .level-low  { background: rgba(34,197,94,0.15);  color: #4ade80; }
        .level-mod  { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .level-high { background: rgba(239,68,68,0.15);  color: #f87171; }

        /* â”€â”€ Sun card â”€â”€ */
        .sun-card { grid-column: span 2; background: var(--card); border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(10px); padding: 20px; }
        .sun-row { display: flex; justify-content: space-around; align-items: center; }
        .sun-item { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .sun-time { font-size: 1.4rem; font-weight: 800; color: var(--text); }
        .sun-label { font-size: 0.7rem; text-transform: uppercase; color: var(--label); font-weight: 800; }
        .sun-divider { width: 1px; height: 50px; background: var(--border); }

        /* â”€â”€ AQI card (commented out â€” enable when API key is ready) â”€â”€ */
        /* .aqi-card { grid-column: span 2; background: var(--card); border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(10px); padding: 20px; }
        .aqi-bar-track { height: 8px; border-radius: 4px; background: linear-gradient(to right, #4ade80,#fbbf24,#f97316,#f87171,#c084fc,#7f1d1d); margin: 10px 0 6px; position: relative; }
        .aqi-bar-dot { position: absolute; top: 50%; width: 14px; height: 14px; border-radius: 50%; background: #fff; border: 2px solid #0b1120; transform: translate(-50%, -50%); transition: left 0.8s ease; } */

        .val { font-size: 1.8rem; font-weight: 800; display: block; margin: 5px 0; color: var(--text); }
        .label { font-size: 0.75rem; text-transform: uppercase; color: var(--label); font-weight: 800; }
    </style>
</head>
<body>
<!-- Pull to refresh indicator -->
<div id="ptr-indicator">
    <div id="ptr-spinner"></div>
    <span id="ptr-text">Pull to refresh</span>
</div>

<!-- Toast -->
<div id="toast"></div>

<div class="container">
    <div class="header-row">
        <div class="header-left">
            <span class="weather-icon" id="weather-icon">ğŸŒ¤</span>
            <div>
                <h1 id="city-title">Syncing...</h1>
                <p id="condition-line">â€”</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="shareLocation()" title="Share">
                <i data-lucide="share-2" style="width:16px;height:16px;"></i>
            </button>
            <button class="icon-btn" id="theme-btn" onclick="toggleTheme()" title="Toggle theme">
                <i data-lucide="sun" style="width:16px;height:16px;"></i>
            </button>
        </div>
    </div>

    <!-- Relay/VPN warning banner -->
    <div id="relay-banner">
        <span class="relay-icon">âš ï¸</span>
        <div class="relay-text">
            <span class="relay-title">Location may be inaccurate</span>
            <span class="relay-sub">iCloud Private Relay or a VPN is masking your real location. Tap the button below to fix it.</span>
        </div>
    </div>

    <p id="updated" style="font-size:11px; color:var(--label); margin:5px 0 14px 0;">Connecting... <span id="data-age"></span></p>

    <button id="gps-btn" onclick="getGPS()">
        <i data-lucide="map-pin"></i>
        <span id="gps-text">Use My Current Location</span>
    </button>

    <div class="search-container">
        <input type="text" id="zip-input" placeholder="Enter zip code" maxlength="5" inputmode="numeric" pattern="[0-9]*">
        <button onclick="searchZip()">Go</button>
    </div>

    <div class="grid">

        <!-- Temperature -->
        <div class="card skeleton" id="card-temp">
            <button class="card-toggle" onclick="toggleInfo('temp-info', this)">
                <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
            </button>
            <span class="label">Temperature</span>
            <span class="val" id="temp">--Â°</span>
            <span id="feels" class="label">Feels --Â°</span>
            <div class="card-info" id="temp-info"><div class="card-info-inner" id="temp-info-text"></div></div>
        </div>

        <!-- Humidity -->
        <div class="card skeleton" id="card-hum">
            <button class="card-toggle" onclick="toggleInfo('hum-info', this)">
                <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
            </button>
            <span class="label">Humidity</span>
            <span class="val" id="hum">--%</span>
            <span class="label">Atmosphere</span>
            <div class="card-info" id="hum-info"><div class="card-info-inner" id="hum-info-text"></div></div>
        </div>

        <!-- UV Index -->
        <div class="card skeleton" id="card-uv">
            <button class="card-toggle" onclick="toggleInfo('uv-info', this)">
                <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
            </button>
            <span class="label">UV Index</span>
            <span class="val" id="uv">--</span>
            <span class="label">Sun Safety</span>
            <div class="card-info" id="uv-info"><div class="card-info-inner" id="uv-info-text"></div></div>
        </div>

        <!-- Wind Speed -->
        <div class="card skeleton" id="card-wind">
            <button class="card-toggle" onclick="toggleInfo('wind-info', this)">
                <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
            </button>
            <span class="label">Wind Speed</span>
            <span class="val" id="wind">-- mph</span>
            <span class="label">Velocity</span>
            <div class="card-info" id="wind-info"><div class="card-info-inner" id="wind-info-text"></div></div>
        </div>

        <!-- Precip Chance -->
        <div class="card skeleton" id="card-precip">
            <button class="card-toggle" onclick="toggleInfo('precip-info', this)">
                <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
            </button>
            <span class="label">Rain Chance</span>
            <span class="val" id="precip">--%</span>
            <span class="label">Precipitation</span>
            <div class="card-info" id="precip-info"><div class="card-info-inner" id="precip-info-text"></div></div>
        </div>

        <!-- Visibility -->
        <div class="card skeleton" id="card-vis">
            <button class="card-toggle" onclick="toggleInfo('vis-info', this)">
                <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
            </button>
            <span class="label">Visibility</span>
            <span class="val" id="visibility">-- mi</span>
            <span class="label">Clarity</span>
            <div class="card-info" id="vis-info"><div class="card-info-inner" id="vis-info-text"></div></div>
        </div>

        <!-- Car Wash -->
        <div class="card" id="card-wash" style="grid-column:span 2; display:flex; align-items:flex-start; gap:12px; background:rgba(56,189,248,0.1); border:1px solid rgba(56,189,248,0.2); flex-direction:column; padding:20px;">
            <div style="display:flex; align-items:center; gap:12px; width:100%; position:relative;">
                <i data-lucide="car" style="color:var(--accent); width:28px; height:28px; flex-shrink:0;"></i>
                <div style="flex:1;">
                    <span class="label" style="color:var(--accent);">Car Wash Forecast</span>
                    <span id="wash-text" style="display:block; font-weight:800; font-size:1.2rem;">Analyzing...</span>
                </div>
                <button class="card-toggle" style="position:relative; top:auto; right:auto; flex-shrink:0;" onclick="toggleInfo('wash-info', this)">
                    <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
                </button>
            </div>
            <div class="card-info" id="wash-info" style="width:100%; margin-top:0;">
                <div class="card-info-inner" id="wash-info-text"></div>
            </div>
        </div>

        <!-- AQI â€” commented out until API key is configured
        <div class="aqi-card">
            <span class="label">ğŸŒ¬ Air Quality Index</span>
            <div style="display:flex; align-items:baseline; gap:10px; margin-top:8px;">
                <span class="val" id="aqi-val" style="margin:0;">--</span>
                <span id="aqi-label" style="font-weight:800; font-size:0.9rem; color:var(--label);">Loading...</span>
            </div>
            <div class="aqi-bar-track">
                <div class="aqi-bar-dot" id="aqi-dot" style="left:0%"></div>
            </div>
            <span id="aqi-main-pollutant" style="font-size:0.7rem; color:var(--label);"></span>
        </div>
        -->

        <!-- Outdoor Score -->
        <div class="outdoor-card">
            <span class="label" style="display:block; margin-bottom:12px;">ğŸƒ Outdoor Conditions Score</span>
            <div class="outdoor-score-row">
                <div class="outdoor-score-circle" id="outdoor-circle">
                    <span class="outdoor-score-num" id="outdoor-num">--</span>
                    <span class="outdoor-score-label">/ 100</span>
                </div>
                <div class="outdoor-score-detail">
                    <span class="outdoor-score-title" id="outdoor-title">Calculating...</span>
                    <span class="outdoor-score-desc" id="outdoor-desc"></span>
                    <div class="outdoor-score-factors" id="outdoor-factors"></div>
                </div>
            </div>
        </div>

        <!-- Sun Schedule -->
        <div class="sun-card" style="position:relative;">
            <button class="card-toggle" onclick="toggleInfo('sun-info', this)">
                <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
            </button>
            <span class="label" style="display:block; margin-bottom:14px;">â˜€ï¸ Sun Schedule</span>
            <div class="sun-row">
                <div class="sun-item">
                    <i data-lucide="sunrise" style="color:#fbbf24; width:32px; height:32px;"></i>
                    <span class="sun-time" id="sunrise-time">--:--</span>
                    <span class="sun-label">Sunrise</span>
                </div>
                <div class="sun-divider"></div>
                <div class="sun-item">
                    <svg viewBox="0 0 120 60" style="width:80px;height:40px;">
                        <path d="M10,55 A50,50 0 0,1 110,55" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4" stroke-linecap="round"/>
                        <path id="sun-arc-progress" d="M10,55 A50,50 0 0,1 110,55" fill="none" stroke="#fbbf24" stroke-width="4" stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="157"/>
                        <circle id="sun-dot" cx="10" cy="55" r="5" fill="#fbbf24"/>
                    </svg>
                    <span class="sun-label" id="daylight-label">-- hrs</span>
                </div>
                <div class="sun-divider"></div>
                <div class="sun-item">
                    <i data-lucide="sunset" style="color:#f97316; width:32px; height:32px;"></i>
                    <span class="sun-time" id="sunset-time">--:--</span>
                    <span class="sun-label">Sunset</span>
                </div>
            </div>
            <div class="card-info" id="sun-info"><div class="card-info-inner" id="sun-info-text"></div></div>
        </div>

        <!-- Related Triggers -->
        <div class="triggers-card" style="position:relative;">
            <button class="card-toggle" onclick="toggleInfo('triggers-info', this)">
                <i data-lucide="chevron-right" style="width:14px;height:14px;"></i>
            </button>
            <span class="label">ğŸŒ¿ Related Allergy Triggers</span>
            <div class="triggers-grid">
                <div class="trigger-item">
                    <span class="trigger-icon">ğŸ„</span>
                    <span class="trigger-label">Mold</span>
                    <span class="trigger-level" id="mold-level">--</span>
                    <span class="trigger-note" id="mold-note"></span>
                </div>
                <div class="trigger-item">
                    <span class="trigger-icon">ğŸ’¨</span>
                    <span class="trigger-label">Dust</span>
                    <span class="trigger-level" id="dust-level">--</span>
                    <span class="trigger-note" id="dust-note"></span>
                </div>
                <div class="trigger-item">
                    <span class="trigger-icon">ğŸŒ¡ï¸</span>
                    <span class="trigger-label">Heat Stress</span>
                    <span class="trigger-level" id="heat-level">--</span>
                    <span class="trigger-note" id="heat-note"></span>
                </div>
                <div class="trigger-item">
                    <span class="trigger-icon">ğŸŒ§ï¸</span>
                    <span class="trigger-label">Rain Relief</span>
                    <span class="trigger-level" id="rain-level">--</span>
                    <span class="trigger-note" id="rain-note"></span>
                </div>
            </div>
            <div class="card-info" id="triggers-info"><div class="card-info-inner" id="triggers-info-text"></div></div>
        </div>

        <!-- Rain Radar -->
        <div class="card" style="grid-column:span 2; padding:0; overflow:hidden; border-radius:24px;">
            <div style="padding:16px 20px 12px; display:flex; align-items:center; gap:8px;">
                <i data-lucide="radar" style="color:var(--accent); width:18px; height:18px;"></i>
                <span class="label" style="color:var(--accent);">Rain Radar</span>
            </div>
            <iframe id="radar-iframe"
                src="https://www.rainviewer.com/map.html?loc=29.7408,-98.6444,8&oFa=0&oC=0&oU=0&oCS=1&oF=0&oAP=0&rmt=4&c=3&o=83&lm=1&layer=radar&sm=1&sn=1"
                style="width:100%; height:320px; border:none; display:block;" allowfullscreen></iframe>
        </div>

        <!-- Pollen widget -->
        <div class="pollen-wrapper">
            <!-- Notice banner sits ABOVE iframe â€” no overlay, guaranteed visible on all browsers -->
            <div id="pollen-notice">
                <span class="pn-icon">ğŸŒ¿</span>
                <div class="pn-text">
                    <span class="pn-title">Loading Allergy Forecast</span>
                    <span class="pn-sub">A short ad may appear first â€” pollen data follows right after.</span>
                </div>
                <div class="pn-bar"><div class="pn-bar-fill"></div></div>
            </div>
            <div class="pollen-notice-wrap">
                <iframe id="pollen-iframe" src="/pollen-test.html" scrolling="no"></iframe>
            </div>
            <div class="pollen-level-row">
                <span class="pollen-level-label">Set level shown in widget above:</span>
                <div class="pollen-level-btns">
                    <button class="plvl-btn" data-level="0" onclick="setPollenLevel(0)" title="0â€“2.4">Low</button>
                    <button class="plvl-btn" data-level="1" onclick="setPollenLevel(1)" title="2.5â€“4.8">Low-Med</button>
                    <button class="plvl-btn" data-level="2" onclick="setPollenLevel(2)" title="4.9â€“7.2">Medium</button>
                    <button class="plvl-btn" data-level="3" onclick="setPollenLevel(3)" title="7.3â€“9.6">Med-High</button>
                    <button class="plvl-btn" data-level="4" onclick="setPollenLevel(4)" title="9.7â€“12">High</button>
                </div>
            </div>
            <div class="pollen-chips" id="pollen-chips"></div>
        </div>

    </div>
</div>

<script>
// â”€â”€ PWA service worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentZip = '78015'; // overridden in DOMContentLoaded
let currentLat = 29.7408, currentLon = -98.6444;
let weatherData = {};
let currentPollenLevel = null;
let autoRefreshTimer = null;
let userHasInteracted = false; // gate vibrate until user taps something

// Mark interaction on first tap/click anywhere
document.addEventListener('pointerdown', () => { userHasInteracted = true; }, { once: true });

lucide.createIcons();

// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('theme-meta').content = theme === 'dark' ? '#0b1120' : '#f0f4f8';
    const btn = document.getElementById('theme-btn');
    btn.innerHTML = theme === 'dark'
        ? '<i data-lucide="sun" style="width:16px;height:16px;"></i>'
        : '<i data-lucide="moon" style="width:16px;height:16px;"></i>';
    lucide.createIcons();
    localStorage.setItem('theme', theme);
}
function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    applyTheme(current === 'dark' ? 'light' : 'dark');
}
applyTheme(localStorage.getItem('theme') || 'dark');

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, duration = 2500) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), duration);
}

// â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareLocation() {
    const url = `${location.origin}${location.pathname}?zip=${currentZip}`;
    if (navigator.share) {
        navigator.share({ title: 'Acekallas Weather', url }).catch(() => {});
    } else {
        navigator.clipboard.writeText(url).then(() => showToast('ğŸ“‹ Link copied!')).catch(() => showToast('Copy failed'));
    }
    if (userHasInteracted && navigator.vibrate) navigator.vibrate(30);
}

// â”€â”€ Pull to refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ptrStartY = 0, ptrTriggered = false;
document.addEventListener('touchstart', e => { ptrStartY = e.touches[0].clientY; ptrTriggered = false; }, { passive: true });
document.addEventListener('touchmove', e => {
    const delta = e.touches[0].clientY - ptrStartY;
    if (window.scrollY === 0 && delta > 60 && !ptrTriggered) {
        ptrTriggered = true;
        const ptr = document.getElementById('ptr-indicator');
        document.getElementById('ptr-text').innerText = 'Release to refresh';
        ptr.classList.add('visible');
    }
}, { passive: true });
document.addEventListener('touchend', () => {
    if (ptrTriggered) {
        const ptr = document.getElementById('ptr-indicator');
        document.getElementById('ptr-text').innerText = 'Refreshing...';
        document.getElementById('ptr-spinner').classList.add('spin');
        if (userHasInteracted && navigator.vibrate) navigator.vibrate(40);
        update(currentLat, currentLon).finally(() => {
            setTimeout(() => {
                ptr.classList.remove('visible');
                document.getElementById('ptr-spinner').classList.remove('spin');
                document.getElementById('ptr-text').innerText = 'Pull to refresh';
            }, 600);
        });
        ptrTriggered = false;
    }
});

// â”€â”€ Skeleton helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const skeletonIds = ['card-temp','card-hum','card-uv','card-wind','card-precip','card-vis'];
function showSkeletons() { skeletonIds.forEach(id => document.getElementById(id)?.classList.add('skeleton')); }
function hideSkeletons() { skeletonIds.forEach(id => document.getElementById(id)?.classList.remove('skeleton')); }

// â”€â”€ Weather condition icon + description â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const weatherIcons = {
    1000:'â˜€ï¸', 1001:'â˜ï¸', 1100:'ğŸŒ¤', 1101:'â›…', 1102:'ğŸŒ¥',
    2000:'ğŸŒ«', 2100:'ğŸŒ',
    4000:'ğŸŒ¦', 4001:'ğŸŒ§', 4200:'ğŸŒ¦', 4201:'ğŸŒ§',
    5000:'ğŸŒ¨', 5001:'ğŸŒ¨', 5100:'ğŸŒ¨', 5101:'â„ï¸',
    6000:'ğŸŒ§', 6001:'ğŸŒ§', 6200:'ğŸŒ§', 6201:'ğŸŒ§',
    7000:'ğŸŒ©', 7101:'ğŸŒ©', 7102:'ğŸŒ©',
    8000:'â›ˆ'
};
const weatherDesc = {
    1000:'Clear', 1001:'Cloudy', 1100:'Mostly Clear', 1101:'Partly Cloudy', 1102:'Mostly Cloudy',
    2000:'Fog', 2100:'Light Fog',
    4000:'Drizzle', 4001:'Rain', 4200:'Light Rain', 4201:'Heavy Rain',
    5000:'Snow', 5001:'Flurries', 5100:'Light Snow', 5101:'Heavy Snow',
    6000:'Freezing Drizzle', 6001:'Freezing Rain', 6200:'Light Freezing Rain', 6201:'Heavy Freezing Rain',
    7000:'Ice Pellets', 7101:'Heavy Ice Pellets', 7102:'Light Ice Pellets',
    8000:'Thunderstorm'
};
function getWeatherIcon(code) { return weatherIcons[code] || 'ğŸŒ¤'; }
function getWeatherDesc(code) { return weatherDesc[code] || 'Partly Cloudy'; }

// â”€â”€ Outdoor score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateOutdoorScore(temp, uv, wind, precipChance, humidity) {
    // Score each factor 0â€“25, sum to 100
    let score = 100;
    const factors = [];

    // Temperature comfort (ideal 65â€“80Â°F)
    if (temp < 32)       { score -= 30; factors.push('ğŸ¥¶ Freezing'); }
    else if (temp < 50)  { score -= 15; factors.push('â„ï¸ Cold'); }
    else if (temp < 60)  { score -= 5;  factors.push('ğŸ§¥ Cool'); }
    else if (temp <= 85) { /* ideal */  factors.push('ğŸŒ¡ï¸ Great temp'); }
    else if (temp <= 95) { score -= 15; factors.push('ğŸ”¥ Hot'); }
    else                 { score -= 30; factors.push('ğŸŒ‹ Extreme heat'); }

    // UV
    if (uv >= 8)       { score -= 20; factors.push('ğŸ”´ Extreme UV'); }
    else if (uv >= 6)  { score -= 10; factors.push('ğŸŸ  High UV'); }
    else if (uv >= 3)  { score -= 3;  factors.push('ğŸŸ¡ Moderate UV'); }
    else               { factors.push('ğŸŸ¢ Low UV'); }

    // Wind
    if (wind >= 30)      { score -= 20; factors.push('ğŸ’¨ Very windy'); }
    else if (wind >= 18) { score -= 8;  factors.push('ğŸŒ¬ Breezy'); }
    else                 { factors.push('âœ… Calm wind'); }

    // Rain chance
    if (precipChance >= 70)      { score -= 20; factors.push('â›ˆ Likely rain'); }
    else if (precipChance >= 40) { score -= 10; factors.push('ğŸŒ§ Possible rain'); }
    else if (precipChance >= 20) { score -= 3;  factors.push('ğŸŒ¦ Slight chance'); }
    else                         { factors.push('â˜€ï¸ Dry'); }

    // Humidity comfort
    if (humidity >= 80)      { score -= 10; factors.push('ğŸ’¦ Very humid'); }
    else if (humidity >= 65) { score -= 4;  factors.push('ğŸ˜“ Humid'); }
    else if (humidity < 20)  { score -= 4;  factors.push('ğŸœï¸ Very dry'); }

    score = Math.max(0, Math.min(100, score));

    let title, color, borderColor;
    if (score >= 85)      { title = 'Excellent â€” Get Outside!'; color = '#4ade80'; borderColor = '#4ade80'; }
    else if (score >= 70) { title = 'Good Conditions';          color = '#a3e635'; borderColor = '#a3e635'; }
    else if (score >= 55) { title = 'Fair â€” Plan Accordingly';  color = '#fbbf24'; borderColor = '#fbbf24'; }
    else if (score >= 35) { title = 'Poor â€” Limit Exposure';    color = '#f97316'; borderColor = '#f97316'; }
    else                  { title = 'Stay Indoors';             color = '#f87171'; borderColor = '#f87171'; }

    const descs = {
        'Excellent â€” Get Outside!': 'Near-perfect conditions. Great for any outdoor activity.',
        'Good Conditions': 'Comfortable outside with minor considerations.',
        'Fair â€” Plan Accordingly': 'Manageable but some factors worth noting.',
        'Poor â€” Limit Exposure': 'Multiple conditions making outdoor time uncomfortable.',
        'Stay Indoors': 'Conditions are harsh. Plan indoor activities instead.'
    };

    document.getElementById('outdoor-num').innerText = score;
    document.getElementById('outdoor-num').style.color = color;
    document.getElementById('outdoor-title').innerText = title;
    document.getElementById('outdoor-title').style.color = color;
    document.getElementById('outdoor-desc').innerText = descs[title];
    const circle = document.getElementById('outdoor-circle');
    circle.style.borderColor = borderColor;
    circle.style.background = borderColor + '15';
    document.getElementById('outdoor-factors').innerHTML = factors.map(f =>
        `<span class="score-factor">${f}</span>`).join('');
}

// â”€â”€ Live data age counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastUpdateTime = null;
let ageTimer = null;
function startAgeCounter() {
    lastUpdateTime = Date.now();
    clearInterval(ageTimer);
    ageTimer = setInterval(() => {
        const mins = Math.floor((Date.now() - lastUpdateTime) / 60000);
        const el = document.getElementById('data-age');
        if (el) el.innerText = mins < 1 ? 'just now' : `${mins}m ago`;
    }, 30000); // update every 30s
}

// â”€â”€ Card toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleInfo(id, btn) {
    const panel = document.getElementById(id);
    const isOpen = panel.classList.contains('open');
    document.querySelectorAll('.card-info').forEach(p => p.classList.remove('open'));
    document.querySelectorAll('.card-toggle').forEach(b => b.classList.remove('open'));
    if (!isOpen) { panel.classList.add('open'); btn.classList.add('open'); }
    if (userHasInteracted && navigator.vibrate) navigator.vibrate(15);
}

// â”€â”€ Info panel content builders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTempInfo(temp, feels, humidity) {
    let badge, color;
    if (temp <= 32)      { badge='ğŸ¥¶ Freezing';    color='#93c5fd'; }
    else if (temp <= 50) { badge='ğŸ§¥ Cold';         color='#93c5fd'; }
    else if (temp <= 65) { badge='ğŸŒ¤ Cool';          color='#6ee7b7'; }
    else if (temp <= 80) { badge='ğŸ˜Š Comfortable';  color='#4ade80'; }
    else if (temp <= 90) { badge='â˜€ï¸ Warm';          color='#fbbf24'; }
    else if (temp<=100)  { badge='ğŸ”¥ Hot';           color='#f97316'; }
    else                 { badge='ğŸŒ‹ Extreme Heat';  color='#f87171'; }
    const diff = Math.abs(temp - feels);
    const feelNote = diff >= 5 ? (feels < temp
        ? `Wind chill making it feel <strong>${diff}Â° cooler</strong>.`
        : `Humidity making it feel <strong>${diff}Â° warmer</strong>.`) : '';
    const descs = { 'ğŸ¥¶ Freezing':'Freezing conditions. Limit time outdoors.',
        'ğŸ§¥ Cold':'Dress warmly. Good for brisk outdoor activity.',
        'ğŸŒ¤ Cool':'Light jacket recommended. Pleasant for most activities.',
        'ğŸ˜Š Comfortable':'Great conditions for being outside.',
        'â˜€ï¸ Warm':'Stay hydrated and seek shade during peak hours.',
        'ğŸ”¥ Hot':'Limit strenuous outdoor activity. Drink plenty of water.',
        'ğŸŒ‹ Extreme Heat':'Dangerous heat. Avoid outdoor activity if possible.' };
    return `<span class="info-badge" style="background:${color}22;color:${color};">${badge}</span><br>${descs[badge]}${feelNote ? '<br><br>' + feelNote : ''}`;
}
function getHumidityInfo(hum) {
    let badge, color, desc;
    if (hum < 25)      { badge='ğŸœï¸ Very Dry';    color='#f87171'; desc='Can cause dry skin and irritated sinuses.'; }
    else if (hum < 40) { badge='ğŸ’§ Dry';           color='#fbbf24'; desc='Slightly dry but comfortable for most.'; }
    else if (hum < 60) { badge='âœ… Comfortable';   color='#4ade80'; desc='Ideal range. Air feels fresh.'; }
    else if (hum < 75) { badge='ğŸ’¦ Humid';         color='#fbbf24'; desc='Sweat evaporates slowly, heat feels more intense.'; }
    else               { badge='ğŸŒŠ Very Humid';    color='#f87171'; desc='High humidity. The body struggles to cool itself.'; }
    return `<span class="info-badge" style="background:${color}22;color:${color};">${badge}</span><br>${desc}`;
}
function getUVInfo(uv) {
    let badge, color, desc;
    if (uv <= 2)      { badge='ğŸŸ¢ Low';      color='#4ade80'; desc='Minimal protection needed for short exposure.'; }
    else if (uv <= 5) { badge='ğŸŸ¡ Moderate'; color='#fbbf24'; desc='Wear sunscreen and a hat during midday.'; }
    else if (uv <= 7) { badge='ğŸŸ  High';     color='#f97316'; desc='Cover up and seek shade during peak hours (10amâ€“4pm).'; }
    else if (uv<=10)  { badge='ğŸ”´ Very High';color='#f87171'; desc='Unprotected skin can burn quickly. Minimize midday exposure.'; }
    else              { badge='ğŸŸ£ Extreme';  color='#c084fc'; desc='Avoid outdoor activity during peak UV hours if possible.'; }
    return `<span class="info-badge" style="background:${color}22;color:${color};">${badge}</span><br>${desc}`;
}
function getWindInfo(wind) {
    let badge, color, desc;
    if (wind < 5)       { badge='ğŸƒ Calm';       color='#4ade80'; desc='Still air. Ideal for outdoor dining and events.'; }
    else if (wind < 12) { badge='ğŸŒ¬ Light Breeze';color='#6ee7b7'; desc='Gentle breeze. Pleasant for most outdoor activities.'; }
    else if (wind < 20) { badge='ğŸ’¨ Moderate';    color='#fbbf24'; desc='Noticeable wind. Loose items may be disturbed.'; }
    else if (wind < 30) { badge='ğŸŒ€ Strong';      color='#f97316'; desc='Strong wind. Secure loose outdoor items.'; }
    else                { badge='âš ï¸ High Wind';   color='#f87171'; desc='Hazardous conditions. Secure all outdoor furniture.'; }
    return `<span class="info-badge" style="background:${color}22;color:${color};">${badge}</span><br>${desc}`;
}

function getPrecipInfo(pct) {
    let badge, color, desc;
    if (pct <= 10)      { badge='â˜€ï¸ Very Unlikely'; color='#4ade80'; desc='Clear skies expected. No rain gear needed.'; }
    else if (pct <= 30) { badge='ğŸŒ¤ Slight Chance'; color='#a3e635'; desc='Rain possible but unlikely. You probably won\'t need an umbrella.'; }
    else if (pct <= 50) { badge='ğŸŒ¦ Possible';       color='#fbbf24'; desc='A coin flip. Consider keeping an umbrella handy.'; }
    else if (pct <= 70) { badge='ğŸŒ§ Likely';          color='#f97316'; desc='Rain is probable. Bring an umbrella and plan accordingly.'; }
    else                { badge='â›ˆ Very Likely';    color='#f87171'; desc='Rain is highly expected. Plan outdoor activities around it.'; }
    return `<span class="info-badge" style="background:${color}22;color:${color};">${badge}</span><br>${desc}`;
}
function getVisibilityInfo(vis) {
    let badge, color, desc;
    if (vis >= 7)       { badge='ğŸ‘ Clear';         color='#4ade80'; desc='Excellent visibility. Great for driving and outdoor activities.'; }
    else if (vis >= 4)  { badge='ğŸŒ¤ Good';           color='#a3e635'; desc='Good visibility with minor haze possible.'; }
    else if (vis >= 2)  { badge='ğŸŒ« Reduced';        color='#fbbf24'; desc='Moderate haze or fog. Drive with headlights on.'; }
    else                { badge='ğŸŒ Poor';           color='#f87171'; desc='Low visibility. Exercise caution when driving. Fog or heavy conditions possible.'; }
    return `<span class="info-badge" style="background:${color}22;color:${color};">${badge}</span><br>${desc}`;
}
function getWashInfo(uv, wind) {
    if (uv > 1 && wind < 18) return `<span class="info-badge" style="background:#38bdf822;color:#38bdf8;">âœ¨ Great Conditions</span><br>Low wind and good sun means your car will dry quickly and evenly without water spots. Perfect time to wash.`;
    if (wind >= 18) return `<span class="info-badge" style="background:#f9731622;color:#f97316;">ğŸ’¨ Too Windy</span><br>Wind above 18 mph will blow dust and debris back onto a freshly washed car. Wait for calmer conditions.`;
    return `<span class="info-badge" style="background:#94a3b822;color:#94a3b8;">ğŸŒ™ Low UV</span><br>Low UV means slow drying and potential water spots. Better to wash on a sunnier day.`;
}
function getSunInfo(sunrise, sunset, daylight) {
    const hrs = parseFloat(daylight);
    let desc = '';
    if (hrs >= 14)      desc = 'Long summer day with lots of daylight. UV peaks sharply around midday â€” plan shade breaks.';
    else if (hrs >= 12) desc = 'Near equal day and night. A balanced day â€” enjoy the long light while it lasts.';
    else if (hrs >= 10) desc = 'Shorter autumn or winter day. Outdoor time is limited, make the most of the midday light.';
    else                desc = 'Short day with limited daylight. The sun sets early â€” plan outdoor activities for the morning.';
    return `<span class="info-badge" style="background:#fbbf2422;color:#fbbf24;">ğŸŒ… ${daylight} hrs of daylight</span><br>${desc}<br><br>Pollen counts are typically highest from <strong>5amâ€“10am</strong>, peaking before noon.`;
}
function getTriggersInfo(humidity, wind, precipChance) {
    return `Trigger levels are calculated from current conditions â€” no separate data source needed.<br><br>
<strong>ğŸ„ Mold</strong> rises when humidity exceeds 60%. Damp surfaces and standing water accelerate spore release.<br><br>
<strong>ğŸ’¨ Dust</strong> stirs at wind speeds above 10 mph. Higher winds carry particulates farther and keep them airborne longer.<br><br>
<strong>ğŸŒ¡ï¸ Heat Stress</strong> uses the Rothfusz heat index formula combining temperature and humidity to estimate how the body actually feels.<br><br>
<strong>ğŸŒ§ï¸ Rain Relief</strong> reflects how likely incoming rain is to wash pollen out of the air. Above 60% chance, the air gets a reset.`;
}
function updateTriggers(temp, humidity, wind, precipChance) {
    const set = (id, noteId, cls, text, note) => {
        document.getElementById(id).className = 'trigger-level ' + cls;
        document.getElementById(id).innerText = text;
        document.getElementById(noteId).innerText = note;
    };
    // Mold â€” humidity
    if (humidity >= 75)      set('mold-level','mold-note','level-high','High','Favor indoor air');
    else if (humidity >= 60) set('mold-level','mold-note','level-mod','Moderate','Check damp areas');
    else                     set('mold-level','mold-note','level-low','Low','Good conditions');
    // Dust â€” wind
    if (wind >= 20)      set('dust-level','dust-note','level-high','High','Close windows');
    else if (wind >= 10) set('dust-level','dust-note','level-mod','Moderate','Some stirring');
    else                 set('dust-level','dust-note','level-low','Low','Minimal disturbance');
    // Heat stress â€” Rothfusz heat index
    let hi = temp;
    if (temp >= 80) hi = -42.379 + 2.04901523*temp + 10.14333127*humidity - 0.22475541*temp*humidity
        - 0.00683783*temp*temp - 0.05481717*humidity*humidity + 0.00122874*temp*temp*humidity
        + 0.00085282*temp*humidity*humidity - 0.00000199*temp*temp*humidity*humidity;
    if (hi >= 103)      set('heat-level','heat-note','level-high','Dangerous','Limit time outside');
    else if (hi >= 90)  set('heat-level','heat-note','level-mod','Caution','Stay hydrated');
    else                set('heat-level','heat-note','level-low','Normal','Comfortable range');
    // Rain relief â€” high precip chance washes pollen out of air
    if (precipChance >= 60)      set('rain-level','rain-note','level-low','Washing','Rain clears pollen');
    else if (precipChance >= 30) set('rain-level','rain-note','level-mod','Possible','Some relief likely');
    else                         set('rain-level','rain-note','level-high','Dry','No pollen wash-out');
}

// â”€â”€ Pollen chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPollenLevel(level) {
    currentPollenLevel = level;
    document.querySelectorAll('.plvl-btn').forEach(btn => {
        btn.className = 'plvl-btn';
        if (parseInt(btn.dataset.level) === level) btn.classList.add('active-' + level);
    });
    if (userHasInteracted && navigator.vibrate) navigator.vibrate(15);
    updatePollenChips();
}
function updatePollenChips() {
    const month = new Date().getMonth(), wind = weatherData.wind || 0, hour = new Date().getHours();
    let pollenType = month<=0||month>=11?'general':month<=4?'tree':month<=7?'grass':'ragweed';
    const windowChip = (currentPollenLevel >= 3 || wind >= 15)
        ? {icon:'ğŸªŸ',text:'Keep windows closed â€” pollen transport elevated'}
        : currentPollenLevel >= 2
        ? {icon:'ğŸªŸ',text:'Consider closing windows during peak hours'}
        : {icon:'ğŸªŸ',text:'Windows OK â€” pollen transport low today'};
    const isPeak = hour>=5&&hour<=10, isMid = hour>=11&&hour<=16;
    const timeChip = currentPollenLevel >= 4
        ? {icon:'â°',text: isPeak?'High pollen + peak hours â€” minimize outdoor time':'High pollen today â€” keep trips short'}
        : currentPollenLevel >= 2
        ? {icon:'â°',text: isPeak?'Moderate pollen + peak hours â€” shorter outings':isMid?'Moderate pollen â€” afternoon OK':'Pollen lower now â€” good time to go out'}
        : {icon:'â°',text: isPeak?'Low pollen â€” enjoy the outdoors':'Good conditions for outdoor activity'};
    const tips = {
        tree:   [['ğŸŒ³','Change clothes after being outside'],['ğŸŒ³','Avoid shaking out clothing indoors'],['ğŸŒ³','Shower after extended time outdoors']],
        grass:  [['ğŸ‘Ÿ','Wipe shoes before entering home'],['ğŸ‘Ÿ','Use a dust mask when mowing'],['ğŸ‘Ÿ','Avoid mowing and sitting in grass']],
        ragweed:[['ğŸš¿','Rinse hair after prolonged outdoor time'],['ğŸš¿','Keep car windows up when driving'],['ğŸš¿','Rinse hair and wash face after going out']],
        general:[['ğŸ§¤','Wash hands after time outdoors'],['ğŸ§¤','Rinse off after outdoor activity'],['ğŸ§¤','Shower and change clothes when returning inside']]
    };
    const ti = currentPollenLevel===null?0:currentPollenLevel<=1?0:currentPollenLevel<=2?1:2;
    const [icon, text] = tips[pollenType][ti];
    const chips = [windowChip, timeChip, {icon, text}];
    document.getElementById('pollen-chips').innerHTML = chips.map(c=>
        `<div class="chip"><span style="font-size:1rem">${c.icon}</span>${c.text}</div>`).join('');
}

// â”€â”€ AQI (AirNow) â€” commented out until API key is configured â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/* async function updateAQI(zip) {
    try {
        const res = await fetch(`https://www.airnowapi.org/aq/observation/zipCode/current/?format=application/json&zipCode=${zip}&distance=25&API_KEY=YOUR_KEY_HERE`);
        const data = await res.json();
        if (!data || !data.length) { document.getElementById('aqi-label').innerText = 'No data'; return; }
        const top = data.reduce((a, b) => a.AQI > b.AQI ? a : b);
        const aqi = top.AQI;
        document.getElementById('aqi-val').innerText = aqi;
        document.getElementById('aqi-main-pollutant').innerText = `Primary pollutant: ${top.ParameterName}`;
        let label, color;
        if (aqi <= 50)       { label='Good';               color='#4ade80'; }
        else if (aqi <= 100) { label='Moderate';           color='#fbbf24'; }
        else if (aqi <= 150) { label='Unhealthy for Some'; color='#f97316'; }
        else if (aqi <= 200) { label='Unhealthy';          color='#f87171'; }
        else if (aqi <= 300) { label='Very Unhealthy';     color='#c084fc'; }
        else                 { label='Hazardous';          color='#7f1d1d'; }
        document.getElementById('aqi-label').innerText = label;
        document.getElementById('aqi-label').style.color = color;
        document.getElementById('aqi-val').style.color = color;
        const pct = Math.min((aqi / 300) * 100, 100);
        document.getElementById('aqi-dot').style.left = pct + '%';
    } catch(e) { document.getElementById('aqi-label').innerText = 'Unavailable'; }
} */

// â”€â”€ Sun times â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcSunTimes(lat, lon) {
    const now = new Date();
    const n = Math.floor(now.getTime()/86400000) + 2440587.5 - 2451545.0;
    const L = (280.46 + 0.9856474*n) % 360;
    const g = (357.528 + 0.9856003*n) % 360;
    const gR = g*Math.PI/180;
    const lambda = L + 1.915*Math.sin(gR) + 0.02*Math.sin(2*gR);
    const sinDec = Math.sin(23.439*Math.PI/180) * Math.sin(lambda*Math.PI/180);
    const dec = Math.asin(sinDec);
    const cosHA = (Math.cos(90.833*Math.PI/180) - Math.sin(lat*Math.PI/180)*sinDec) /
                  (Math.cos(lat*Math.PI/180)*Math.cos(dec));
    if (cosHA<-1||cosHA>1) return null;
    const HA = Math.acos(cosHA)*180/Math.PI;
    const noon = 720 - 4*lon;
    const srMin = noon - HA*4, ssMin = noon + HA*4;
    const toLocal = m => { const d=new Date(now); d.setUTCHours(0,0,0,0); d.setTime(d.getTime()+m*60000);
        return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true}); };
    const nowMin = now.getUTCHours()*60+now.getUTCMinutes();
    return { sunrise:toLocal(srMin), sunset:toLocal(ssMin),
             daylight:((ssMin-srMin)/60).toFixed(1),
             progressPct: nowMin<srMin?0:nowMin>ssMin?1:(nowMin-srMin)/(ssMin-srMin) };
}
function updateSunWidget(lat, lon) {
    const sun = calcSunTimes(lat, lon); if (!sun) return;
    document.getElementById('sunrise-time').innerText = sun.sunrise;
    document.getElementById('sunset-time').innerText  = sun.sunset;
    document.getElementById('daylight-label').innerText = sun.daylight + ' hrs';
    const prog = document.getElementById('sun-arc-progress');
    prog.style.transition = 'stroke-dashoffset 1s ease';
    prog.setAttribute('stroke-dashoffset', 157 - sun.progressPct*157);
    const a = Math.PI - sun.progressPct*Math.PI;
    document.getElementById('sun-dot').setAttribute('cx', 60-50*Math.cos(a));
    document.getElementById('sun-dot').setAttribute('cy', 55-50*Math.sin(a));
}

// â”€â”€ Pollen notice â€” shows above widget, collapses after delay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPollenNotice() {
    const n = document.getElementById('pollen-notice');
    if (!n) return;
    n.classList.remove('hidden');
    // Collapse after 5 seconds â€” enough time to read it
    clearTimeout(window._pollenNoticeTimer);
    window._pollenNoticeTimer = setTimeout(() => n.classList.add('hidden'), 5000);
}

// â”€â”€ Auto-GPS if permission already granted (avoids Dallas on repeat visits) â”€â”€
async function tryAutoGPS() {
    if (!navigator.permissions || !navigator.geolocation) return;
    try {
        const perm = await navigator.permissions.query({ name: 'geolocation' });
        if (perm.state === 'granted') {
            // Permission already given â€” silently get position without prompting
            navigator.geolocation.getCurrentPosition(
                async p => {
                    const lat = p.coords.latitude;
                    const lon = p.coords.longitude;
                    try {
                        const geo = await (await fetch(
                            `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`,
                            { headers: { 'Accept-Language': 'en' } }
                        )).json();
                        const city = geo.address?.city || geo.address?.town || geo.address?.suburb || geo.address?.county || null;
                        const zip  = geo.address?.postcode?.split('-')[0] || null;
                        update(lat, lon, city, zip);
                    } catch(e) {
                        update(lat, lon, null, null);
                    }
                },
                () => {}, // silently fail â€” page already loaded with saved/default location
                { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
            );
        }
    } catch(e) {}
}
// Fully handled by Cloudflare Worker via cf.asOrganization â€” no client-side check needed.
// The worker injects isRelay:true into every response for relay/VPN connections.
// checkVPN() is kept as a no-op so existing call sites don't break.
function checkVPN() { /* handled by worker */ }

function clearVPNWarning() {
    document.getElementById('relay-banner').classList.remove('visible');
    document.getElementById('gps-btn').classList.remove('pulse');
}

// â”€â”€ Widget updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePollenWidget(zip) {
    currentZip = zip;
    document.getElementById('pollen-iframe').src = `/pollen-test.html?zip=${zip}&t=${Date.now()}`;
    showPollenNotice();
}
function updateRadar(lat, lon) {
    document.getElementById('radar-iframe').src =
        `https://www.rainviewer.com/map.html?loc=${lat},${lon},8&oFa=0&oC=0&oU=0&oCS=1&oF=0&oAP=0&rmt=4&c=3&o=83&lm=1&layer=radar&sm=1&sn=1`;
}

// â”€â”€ GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getGPS() {
    document.getElementById('gps-text').innerText = "Locating...";
    if (userHasInteracted && navigator.vibrate) navigator.vibrate(20);
    if (!navigator.geolocation) { document.getElementById('gps-text').innerText = "GPS Not Supported"; return; }
    navigator.geolocation.getCurrentPosition(
        async p => {
            clearVPNWarning();
            const lat = p.coords.latitude;
            const lon = p.coords.longitude;
            // Reverse-geocode with Nominatim (free, no key, actually supports lat/lon)
            try {
                const geo = await (await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`,
                    { headers: { 'Accept-Language': 'en' } }
                )).json();
                const city = geo.address?.city || geo.address?.town || geo.address?.suburb || geo.address?.county || null;
                const zip  = geo.address?.postcode?.split('-')[0] || null; // trim ZIP+4 to 5 digits
                update(lat, lon, city, zip);
            } catch(e) {
                // Nominatim failed â€” update weather with real coords, worker will use cf.city
                update(lat, lon, null, null);
            }
        },
        (err) => {
            const msg = err.code === 1 ? "Location Access Denied" : err.code === 2 ? "Location Unavailable" : "Location Timed Out";
            document.getElementById('gps-text').innerText = msg + " â€” Try Zip Instead";
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

// â”€â”€ Zip search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function searchZip() {
    const zip = document.getElementById('zip-input').value.trim();
    if (!/^\d{5}$/.test(zip)) {
        document.getElementById('zip-input').style.outline = '2px solid #f87171';
        setTimeout(() => document.getElementById('zip-input').style.outline = '', 1500);
        return;
    }
    document.getElementById('zip-input').style.outline = '';
    if (userHasInteracted && navigator.vibrate) navigator.vibrate(20);
    try {
        const data = await (await fetch(`https://api.zippopotam.us/us/${zip}`)).json();
        clearVPNWarning();
        // Parse as floats â€” zippopotam returns strings
        update(parseFloat(data.places[0].latitude), parseFloat(data.places[0].longitude), data.places[0]['place name'], zip);
    } catch(e) { document.getElementById('updated').innerText = "Invalid ZIP code."; }
}

// â”€â”€ Main update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function update(lat=null, lon=null, name=null, zip=null) {
    showSkeletons();
    try {
        let url = `https://pollen-data.acekallas.com/`;
        const params = [];
        if (lat) { params.push(`lat=${lat}`,`lon=${lon}`); }
        if (name) params.push(`name=${encodeURIComponent(name)}`);
        if (params.length) url += '?' + params.join('&');

        const r = await fetch(url);
        const d = await r.json();
        weatherData = d;

        // Weather icon + city + condition subtitle
        document.getElementById('weather-icon').innerText = getWeatherIcon(d.weatherCode || 1000);
        document.getElementById('city-title').innerText = d.city;
        document.getElementById('condition-line').innerText =
            `${getWeatherDesc(d.weatherCode || 1000)} Â· Feels like ${d.feelsLike}Â°`;

        // Cards
        document.getElementById('temp').innerText      = d.temp + "Â°";
        document.getElementById('feels').innerText     = "Feels " + d.feelsLike + "Â°";
        document.getElementById('hum').innerText       = d.humidity + "%";
        document.getElementById('uv').innerText        = d.uv;
        document.getElementById('wind').innerText      = d.wind + " mph";
        document.getElementById('precip').innerText    = (d.precipChance ?? '--') + "%";
        document.getElementById('visibility').innerText= (d.visibility ?? '--') + " mi";

        const cacheLabel = (r.headers.get('X-Cache')==='HIT'||r.headers.get('cf-cache-status')==='HIT') ? ' Â· âš¡ Cached' : '';
        const relayDebug = d.asOrg ? ` Â· ASN: ${d.asOrg}` : '';
        document.getElementById('updated').innerText = `Updated: ${d.updated}${cacheLabel}${relayDebug}`;
        document.getElementById('wash-text').innerText = (d.uv>1&&d.wind<18) ? "âœ¨ Perfect Day for a Wash" : "âš ï¸ Skip the Wash Today";
        if (lat) document.getElementById('gps-text').innerText = "ğŸ“ Location Set â€” Tap to Update";

        // Info panels
        document.getElementById('temp-info-text').innerHTML     = getTempInfo(d.temp, d.feelsLike, d.humidity);
        document.getElementById('hum-info-text').innerHTML      = getHumidityInfo(d.humidity);
        document.getElementById('uv-info-text').innerHTML       = getUVInfo(d.uv);
        document.getElementById('wind-info-text').innerHTML     = getWindInfo(d.wind);
        document.getElementById('precip-info-text').innerHTML   = getPrecipInfo(d.precipChance ?? 0);
        document.getElementById('vis-info-text').innerHTML      = getVisibilityInfo(d.visibility ?? 10);
        document.getElementById('wash-info-text').innerHTML     = getWashInfo(d.uv, d.wind);
        document.getElementById('triggers-info-text').innerHTML = getTriggersInfo(d.humidity, d.wind, d.precipChance ?? 0);
        // Sun info populated after sun widget updates below

        // Derived widgets
        updateTriggers(d.temp, d.humidity, d.wind, d.precipChance || 0);
        updateOutdoorScore(d.temp, d.uv, d.wind, d.precipChance || 0, d.humidity);
        updatePollenChips();
        startAgeCounter();

        // Persist location â€” save the user-confirmed city name separately from worker city
        // (worker city can be wrong if cf.city returns edge location like Dallas)
        currentLat = d.lat || lat || currentLat;
        currentLon = d.lon || lon || currentLon;
        // Only save city from explicit sources (GPS reverse geocode or zip search), not cf.city fallback
        const cityToSave = (lat && name) ? name : (zip && d.city) ? d.city : localStorage.getItem('lastCity');
        localStorage.setItem('lastLat', currentLat);
        localStorage.setItem('lastLon', currentLon);
        localStorage.setItem('lastZip', currentZip);
        if (cityToSave) localStorage.setItem('lastCity', cityToSave);

        updateSunWidget(currentLat, currentLon);
        updateRadar(currentLat, currentLon);
        // Populate sun info panel after widget runs (so sunrise/sunset times are filled in)
        const sunTimes = calcSunTimes(currentLat, currentLon);
        if (sunTimes) document.getElementById('sun-info-text').innerHTML = getSunInfo(sunTimes.sunrise, sunTimes.sunset, sunTimes.daylight);

        // Always update pollen if we have a zip â€” always reload when zip actually changed
        const targetZip = zip || currentZip;
        if (targetZip !== currentZip || zip) {
            currentZip = targetZip;
            updatePollenWidget(targetZip);
        }
        // updateAQI(targetZip); // â† uncomment when AirNow API key is ready

        // VPN/relay detection from Cloudflare worker ASN check
        if (d.isRelay) {
            document.getElementById('relay-banner').classList.add('visible');
            document.getElementById('gps-btn').classList.add('pulse');
        } else {
            document.getElementById('relay-banner').classList.remove('visible');
            document.getElementById('gps-btn').classList.remove('pulse');
        }

        // Haptic on success
        if (userHasInteracted && navigator.vibrate) navigator.vibrate([30, 50, 30]);

        // Persist location so page restores it on next load
        localStorage.setItem('lastLat', currentLat);
        localStorage.setItem('lastLon', currentLon);
        localStorage.setItem('lastZip', currentZip);
        if (d.city) localStorage.setItem('lastCity', d.city);

        hideSkeletons();

        // Schedule next auto-refresh in 10 min
        clearTimeout(autoRefreshTimer);
        autoRefreshTimer = setTimeout(() => update(currentLat, currentLon), 10 * 60 * 1000);

    } catch(e) {
        console.error(e);
        hideSkeletons();
        document.getElementById('updated').innerText = "Unable to connect â€” retrying...";
        setTimeout(() => update(lat, lon, name, zip), 5000);
    }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('zip-input').addEventListener('keydown', e => { if(e.key==='Enter') searchZip(); });
document.addEventListener('DOMContentLoaded', () => {
    // Restore last location from localStorage, fallback to URL param, then San Antonio
    const savedLat  = parseFloat(localStorage.getItem('lastLat'));
    const savedLon  = parseFloat(localStorage.getItem('lastLon'));
    const savedZip  = localStorage.getItem('lastZip');
    const urlZip    = new URLSearchParams(location.search).get('zip');

    if (urlZip) {
        currentZip = urlZip;
        update(null, null, null, urlZip);
    } else if (savedLat && savedLon) {
        currentLat = savedLat;
        currentLon = savedLon;
        if (savedZip) currentZip = savedZip;
        update(savedLat, savedLon, localStorage.getItem('lastCity'), savedZip);
        // Also try live GPS to get fresher position if permission already granted
        tryAutoGPS();
    } else {
        // First-ever load â€” try GPS first, fall back to San Antonio
        tryAutoGPS();
        update(); // loads San Antonio immediately, GPS will override if granted
    }

    showPollenNotice();
    checkVPN();
    updatePollenChips();
});
</script>
</body>
</html>
