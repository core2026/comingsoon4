<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cedar Radar</title>
    <style>
        body { background: #f1f5f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: sans-serif; }
        .card { width: 350px; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .badge { padding: 15px; border-radius: 12px; font-weight: bold; margin: 20px 0; font-size: 0.85rem; }
        #timestamp { font-size: 0.7rem; color: #94a3b8; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="title">Pollen Radar</h2>
    <p id="loc" style="color:#64748b">Locating...</p>
    <p id="timestamp"></p>
    <div class="badge" id="meter" style="background:#e2e8f0">Initializing...</div>
    <canvas id="pollenChart" height="200"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const WORKER_URL = 'https://pollen-proxy.acekallas.workers.dev'; 

    window.onload = () => {
        navigator.geolocation.getCurrentPosition(
            p => fetchPollen(p.coords.latitude, p.coords.longitude),
            e => fetchPollen(29.70, -98.63) // Default to Fair Oaks Ranch
        );
    };

    async function fetchPollen(lat, lon) {
        const meter = document.getElementById('meter');
        document.getElementById('loc').innerText = "ðŸ“ Fair Oaks Ranch Area";
        
        try {
            const res = await fetch(`${WORKER_URL}?lat=${lat}&lon=${lon}`);
            
            // DIAGNOSTIC: If the worker returns an error, show it!
            if (!res.ok) {
                const errData = await res.json();
                meter.innerText = `Error ${res.status}: ${errData.error || 'Check Console'}`;
                meter.style.background = "#fee2e2";
                return;
            }

            const result = await res.json();
            const data = result.data[0];

            // Success Logic
            document.getElementById('timestamp').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
            const species = data.species.Tree || [];
            const isCedar = species.some(s => s.name === "Juniper");
            if(isCedar) document.getElementById('title').innerText = "Cedar Radar";
            
            updateUI(data.Risk.tree_pollen, data.Risk.grass_pollen, data.Risk.weed_pollen, isCedar);
        } catch (e) {
            meter.innerText = "Connection Failed";
        }
    }

    function updateUI(tree, grass, weed, isCedar) {
        const meter = document.getElementById('meter');
        const colors = { "High": "#ef4444", "Moderate": "#f59e0b", "Low": "#10b981" };
        meter.innerText = `${tree} ${isCedar ? 'Cedar' : 'Tree'} Risk`;
        meter.style.background = colors[tree] || "#e2e8f0";
        meter.style.color = (tree === "High") ? "white" : "black";
        // (Chart logic remains same as previous)
    }
</script>
</body>
</html>
