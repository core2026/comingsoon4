<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas Cedar Radar</title>
    <style>
        body { 
            background-color: #f5f6fa; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        .allergy-container { 
            width: 100%; 
            max-width: 450px; 
            background: #ffffff; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .allergy-header h3 { margin: 0; color: #2d3436; font-size: 1.6rem; }
        #location-status { font-size: 0.85rem; color: #636e72; margin: 8px 0 20px 0; font-style: italic; }
        .sneeze-meter { 
            background: #dfe6e9; 
            padding: 15px; 
            border-radius: 12px; 
            font-weight: 800; 
            margin-bottom: 25px; 
            text-transform: uppercase; 
            transition: all 0.5s ease; 
        }
        .chart-wrapper { position: relative; height: 250px; margin-bottom: 10px; }
        .data-source { font-size: 0.7rem; color: #b2bec3; margin-top: 20px; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="allergy-container">
        <div class="allergy-header">
            <h3>Texas Cedar Radar</h3>
            <p id="location-status">üì° Initializing sensors...</p>
        </div>
        
        <div class="sneeze-meter" id="sneeze-meter">
            <span id="meter-text">Waking up...</span>
        </div>

        <div class="chart-wrapper">
            <canvas id="pollenChart"></canvas>
        </div>

        <p class="data-source">
            Real-time data for Feb 2026<br>
            Powered by Open-Meteo Global Air Quality
        </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        async function initPollenRadar() {
            const statusText = document.getElementById('location-status');
            const meterText = document.getElementById('meter-text');
            const meterBox = document.getElementById('sneeze-meter');

            // 1. Get Location
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                statusText.innerText = `üìç Location: ${lat.toFixed(2)}, ${lon.toFixed(2)}`;

                try {
                    // 2. Fetch Pollen Data (Using the stable European/Global variables)
                    const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=alder_pollen,birch_pollen,grass_pollen,ragweed_pollen`;
                    
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.error) throw new Error("API Error");

                    const p = data.current;
                    // Combine Alder and Birch as a proxy for 'Tree/Cedar'
                    const treeVal = (p.alder_pollen || 0) + (p.birch_pollen || 0);
                    const grassVal = p.grass_pollen || 0;
                    const weedVal = p.ragweed_pollen || 0;

                    updateUI(treeVal, grassVal, weedVal, false);

                } catch (err) {
                    console.error("API Fetch failed, using seasonal fallback:", err);
                    useFallback(statusText);
                }
            }, (error) => {
                console.warn("Location denied, using seasonal fallback.");
                useFallback(statusText);
            });
        }

        function useFallback(statusElement) {
            statusElement.innerText = "‚ö†Ô∏è Using Seasonal Estimates for TX";
            // Typical February levels: High Cedar (85), Low Grass (5), Low Weed (10)
            updateUI(85, 5, 10, true);
        }

        function updateUI(tree, grass, weed, isFallback) {
            const meterText = document.getElementById('meter-text');
            const meterBox = document.getElementById('sneeze-meter');

            // Update Sneeze Meter Logic
            if (tree > 70) {
                meterText.innerText = "üö® CEDAR APOCALYPSE";
                meterBox.style.background = "#ff7675";
                meterBox.style.color = "white";
            } else if (tree > 30) {
                meterText.innerText = "‚ö†Ô∏è High Sneeze Risk";
                meterBox.style.background = "#fdcb6e";
                meterBox.style.color = "black";
            } else {
                meterText.innerText = "ü§† All Clear, Partner";
                meterBox.style.background = "#55efc4";
                meterBox.style.color = "black";
            }

            // Create the Graph
            const ctx = document.getElementById('pollenChart').getContext('2d');
            
            // Clear old chart if it exists
            const existingChart = Chart.getChart("pollenChart");
            if (existingChart) existingChart.destroy();

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Cedar/Tree', 'Grass', 'Ragweed'],
                    datasets: [{
                        label: 'Grains/m¬≥',
                        data: [tree, grass, weed],
                        backgroundColor: ['#d63031', '#00b894', '#fdcb6e'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        initPollenRadar();
    </script>
</body>
</html>
