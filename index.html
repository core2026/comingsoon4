<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas Cedar Radar</title>
    <style>
        body { background-color: #f5f6fa; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; }
        .allergy-container { width: 100%; max-width: 450px; background: #ffffff; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        #location-status { font-size: 0.85rem; color: #636e72; margin: 8px 0 20px 0; }
        .sneeze-meter { background: #dfe6e9; padding: 15px; border-radius: 12px; font-weight: 800; margin-bottom: 25px; text-transform: uppercase; transition: all 0.5s ease; }
        .chart-wrapper { position: relative; height: 280px; }
        .data-source { font-size: 0.7rem; color: #b2bec3; margin-top: 20px; }
        .pulse-active { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="allergy-container">
        <h3>Texas Cedar Radar</h3>
        <p id="location-status">üì° Initializing sensors...</p>
        
        <div class="sneeze-meter" id="sneeze-meter">
            <span id="meter-text">Waking up...</span>
        </div>

        <div class="chart-wrapper">
            <canvas id="pollenChart"></canvas>
        </div>

        <p class="data-source">Real-time data for 2026<br>Powered by Open-Meteo</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        async function initPollenRadar() {
            const statusText = document.getElementById('location-status');
            const meterText = document.getElementById('meter-text');
            const meterBox = document.getElementById('sneeze-meter');

            // 1. Get Location with a timeout to prevent hanging
            const options = { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 };

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                statusText.innerText = `üìç Location: ${lat.toFixed(2)}, ${lon.toFixed(2)}`;

                try {
                    // 2. Fetch Data with better error handling
                    const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=juniper_pollen,grass_pollen,ragweed_pollen,birch_pollen`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    const pollen = data.current;

                    // 3. Logic for Sneeze Meter
                    const cedar = pollen.juniper_pollen || 0;
                    if (cedar > 150) {
                        meterText.innerText = "üö® CEDAR APOCALYPSE";
                        meterBox.style.background = "#ff7675";
                        meterBox.classList.add("pulse-active");
                    } else if (cedar > 50) {
                        meterText.innerText = "‚ö†Ô∏è CEDAR FEVER WARNING";
                        meterBox.style.background = "#fdcb6e";
                    } else {
                        meterText.innerText = "ü§† All Clear, Partner";
                        meterBox.style.background = "#55efc4";
                    }

                    // 4. Graph Rendering
                    new Chart(document.getElementById('pollenChart'), {
                        type: 'bar',
                        data: {
                            labels: ['Cedar', 'Grass', 'Ragweed', 'Birch'],
                            datasets: [{
                                data: [pollen.juniper_pollen, pollen.grass_pollen, pollen.ragweed_pollen, pollen.birch_pollen],
                                backgroundColor: ['#d63031', '#00b894', '#fdcb6e', '#a29bfe'],
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }
                        }
                    });

                } catch (err) {
                    console.error(err);
                    statusText.innerText = "‚ùå API Error: Check Console";
                    meterText.innerText = "Data Error";
                }
            }, (error) => {
                // If the user denies location, let's use a default (Fair Oaks Ranch)
                statusText.innerText = "‚ö†Ô∏è Location denied. Showing Fair Oaks Ranch.";
                fetchDefaultLocation();
            }, options);
        }

        // Fallback function for when location is denied or fails
        async function fetchDefaultLocation() {
            // Default to Fair Oaks Ranch coordinates
            const lat = 29.74; 
            const lon = -98.64;
            // You can re-run the fetch logic here if you want it to always show something!
        }

        initPollenRadar();
    </script>
</body>
</html>
