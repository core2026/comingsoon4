<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollen Radar | Dual-Sync Analytics</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --accent: #10b981; --bg: #020617; --glass: rgba(255, 255, 255, 0.04); }
        body { background: var(--bg); color: white; margin: 0; padding: 10px; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        .dashboard { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 10px; }
        .tile { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 18px; backdrop-filter: blur(12px); position: relative; }
        .engine-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .data-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; text-align: center; }
        .engine-name { font-size: 0.55rem; text-transform: uppercase; color: #64748b; font-weight: 800; margin-bottom: 2px; }
        .engine-val { font-size: 1.3rem; font-weight: 800; color: #f8fafc; }
        .offline { color: #475569; font-size: 0.8rem; font-weight: 400; }
        h2 { font-size: 0.65rem; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0; letter-spacing: 1px; }
        .location-title { font-size: 1.1rem; font-weight: 700; }
        #map { height: 180px; border-radius: 15px; background: #000; border: 1px solid rgba(255,255,255,0.1); margin-top: 5px; }
        .btn-action { background: var(--accent); width: 100%; border: none; padding: 14px; border-radius: 15px; color: white; font-weight: 800; cursor: pointer; margin-top: 10px; }
        .btn-sync { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 8px; color: white; font-size: 0.6rem; cursor: pointer; }
        .timestamp { font-size: 0.6rem; color: #475569; text-align: center; margin-top: 15px; }
    </style>
</head>
<body>

<div id="capture-area" class="dashboard">
    <div class="tile" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2>‚óè Multi-Source Pollen Feed</h2>
            <div id="city-name" class="location-title">Detecting...</div>
        </div>
        <button class="btn-sync" onclick="refreshData()">FORCE SYNC</button>
    </div>

    <div class="tile">
        <h2>Mountain Cedar <span style="color:var(--accent); text-transform: none;">(Primary)</span></h2>
        <div class="engine-row">
            <div class="data-card">
                <div class="engine-name">Ambee Stream</div>
                <div id="ambee-cedar" class="engine-val">--</div>
            </div>
            <div class="data-card">
                <div class="engine-name">Tomorrow.io</div>
                <div id="tomorrow-cedar" class="engine-val">--</div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="tile" style="padding: 12px;">
            <h2>Grass</h2>
            <div style="font-size: 1rem; font-weight: 800; margin-top:5px;">
                <span id="ambee-grass">--</span> <span style="color:#334155;">/</span> <span id="tomorrow-grass">--</span>
            </div>
        </div>
        <div class="tile" style="padding: 12px;">
            <h2>Weeds</h2>
            <div style="font-size: 1rem; font-weight: 800; margin-top:5px;">
                <span id="ambee-weed">--</span> <span style="color:#334155;">/</span> <span id="tomorrow-weed">--</span>
            </div>
        </div>
    </div>

    <div class="tile" style="padding: 5px;"><div id="map"></div></div>

    <div class="tile">
        <h2>Health Analysis</h2>
        <div id="health-advice" style="font-size: 0.75rem; color: #94a3b8; line-height:1.4;">Syncing dual-sensor data...</div>
    </div>
</div>

<div style="width: 100%; max-width: 480px; padding: 10px;">
    <button class="btn-action" onclick="takeSnapshot()">üì∏ Export Report</button>
    <div id="update-time" class="timestamp">Last Updated: --</div>
</div>

<script>
    const WORKER_URL = 'https://pollen-api.acekallas.com';
    let map, marker, currentLat, currentLon;

    window.onload = () => {
        navigator.geolocation.getCurrentPosition(
            (p) => { currentLat = p.coords.latitude; currentLon = p.coords.longitude; updateUI(); },
            () => { currentLat = 29.704; currentLon = -98.636; updateUI(); }
        );
    };

    async function refreshData() {
        document.getElementById('city-name').innerText = "Syncing...";
        updateUI();
    }

    async function updateUI() {
        try {
            // FIX: Open-Meteo Geocoding to bypass 425 error
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/get?name=city&latitude=${currentLat}&longitude=${currentLon}`);
            const g = await geoRes.json();
            document.getElementById('city-name').innerText = g.results?.[0]?.name || "Local Area";

            const res = await fetch(`${WORKER_URL}?lat=${currentLat}&lon=${currentLon}`);
            const data = await res.json();
            render(data);
        } catch (e) { 
            console.error(e); 
            document.getElementById('city-name').innerText = "Sync Error (Check Proxy)";
        }
    }

    function render(results) {
        const a = results.ambee;
        const t = results.tomorrow;

        const aCedar = a ? (a.Species?.Tree["Cypress / Juniper / Cedar"] || 0) : 0;
        const tCedar = t ? t.treeValue : 0;

        document.getElementById('ambee-cedar').innerHTML = a ? Math.round(aCedar) : '<span class="offline">Offline</span>';
        document.getElementById('tomorrow-cedar').innerHTML = t ? Math.round(tCedar) : '<span class="offline">Offline</span>';
        document.getElementById('ambee-grass').innerText = a ? a.Count.grass_pollen : 'N/A';
        document.getElementById('tomorrow-grass').innerText = t ? Math.round(t.grassValue) : 'N/A';
        document.getElementById('ambee-weed').innerText = a ? a.Count.weed_pollen : 'N/A';
        document.getElementById('tomorrow-weed').innerText = t ? Math.round(t.weedValue) : 'N/A';

        const maxCedar = Math.max(aCedar, tCedar);
        let color = '#10b981', msg = "üü¢ <b>Low Risk:</b> Sensors report clear conditions.";
        if (maxCedar > 500) { color = '#ef4444'; msg = "üî¥ <b>High Severity:</b> Significant Cedar activity detected."; }
        else if (maxCedar > 100) { color = '#f59e0b'; msg = "üü° <b>Moderate:</b> Allergy triggers are present."; }

        document.documentElement.style.setProperty('--accent', color);
        document.getElementById('health-advice').innerHTML = msg;
        document.getElementById('update-time').innerText = `Last Updated: ${new Date().toLocaleTimeString()}`;

        if (!map) {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([currentLat, currentLon], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }
        if (marker) map.removeLayer(marker);
        marker = L.marker([currentLat, currentLon], { 
            icon: L.divIcon({ className: 'p-icon', html: `<div style='width:12px;height:12px;border-radius:50%;background:${color};box-shadow:0 0 10px ${color}'></div>` }) 
        }).addTo(map);
    }

    function takeSnapshot() {
        html2canvas(document.querySelector("#capture-area"), { backgroundColor: "#020617", useCORS: true }).then(c => {
            const l = document.createElement('a'); l.download = `PollenReport.png`; l.href = c.toDataURL(); l.click();
        });
    }
</script>
</body>
</html>
